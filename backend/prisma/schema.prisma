// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== USERS & AUTHENTICATION =====

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String?  // nullable for magic link auth
  role      UserRole @default(RESIDENT)
  suburbId  String?  @map("suburb_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  suburb           Suburb?           @relation(fields: [suburbId], references: [id])
  events           Event[]
  homeLocation     UserHomeLocation?
  hostedHOAs       HOA[]
  eventAttendances EventAttendance[]
  magicLinks       MagicLink[]

  @@map("users")
}

model MagicLink {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("magic_links")
}

enum UserRole {
  RESIDENT
  ARTIST
  HOA_ADMIN
}

// ===== SUBURBS & INTELLIGENCE =====

model Suburb {
  id         String     @id @default(uuid())
  name       String
  type       SuburbType
  lat        Float
  lon        Float
  population Int?
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  users         User[]
  events        Event[]
  suburbScores  SuburbScore?
  hoas          HOA[]
  hoaLocations  HOALocation[]

  @@map("suburbs")
}

model SuburbScore {
  id                    String   @id @default(uuid())
  suburbId              String   @unique @map("suburb_id")
  eventDensity          Float    @default(0) @map("event_density") // events per month
  artistInterestScore   Float    @default(0) @map("artist_interest_score") // 0-100 score
  averageAttendance     Float    @default(0) @map("average_attendance")
  lastCalculated        DateTime @default(now()) @map("last_calculated")

  suburb Suburb @relation(fields: [suburbId], references: [id], onDelete: Cascade)

  @@map("suburb_scores")
}

enum SuburbType {
  STARTER      // New, developing suburbs
  ESTABLISHED  // Mature suburbs with active communities
  TIER_3       // Smaller, less active suburbs
}

// ===== EVENTS =====

model Event {
  id               String    @id @default(uuid())
  title            String
  description      String
  hostId           String    @map("host_id")
  hostType         HostType  @map("host_type")
  suburbId         String    @map("suburb_id")
  locationLat      Float     @map("location_lat")
  locationLon      Float     @map("location_lon")
  dateTime         DateTime  @map("date_time")
  category         String
  expectedCapacity Int?      @map("expected_capacity")
  actualAttendance Int       @default(0) @map("actual_attendance")
  hoaLocationId    String?   @map("hoa_location_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  host              User              @relation(fields: [hostId], references: [id])
  suburb            Suburb            @relation(fields: [suburbId], references: [id])
  hoaLocation       HOALocation?      @relation(fields: [hoaLocationId], references: [id])
  eventAttendances  EventAttendance[]

  @@index([suburbId])
  @@index([dateTime])
  @@index([hostId])
  @@map("events")
}

model EventAttendance {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  userId    String   @map("user_id")
  status    AttendanceStatus @default(JOINED)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_attendances")
}

enum HostType {
  RESIDENT
  ARTIST
  HOA
}

enum AttendanceStatus {
  JOINED
  LEFT
}

// ===== HOA INTEGRATION =====

model HOA {
  id        String   @id @default(uuid())
  name      String
  adminId   String   @map("admin_id")
  suburbId  String   @map("suburb_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  admin     User          @relation(fields: [adminId], references: [id])
  suburb    Suburb        @relation(fields: [suburbId], references: [id])
  locations HOALocation[]

  @@map("hoas")
}

model HOALocation {
  id               String   @id @default(uuid())
  hoaId            String   @map("hoa_id")
  suburbId         String   @map("suburb_id")
  lat              Float
  lon              Float
  description      String?
  preferredTypes   String[] @map("preferred_types") // ["music", "fitness", etc.]
  maxCapacity      Int?     @map("max_capacity")
  availableTimes   String?  @map("available_times") // JSON string or simple text
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  hoa    HOA     @relation(fields: [hoaId], references: [id], onDelete: Cascade)
  suburb Suburb  @relation(fields: [suburbId], references: [id])
  events Event[]

  @@index([suburbId])
  @@map("hoa_locations")
}

// ===== RESIDENT HOME HOSTING =====

model UserHomeLocation {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  lat       Float
  lon       Float
  visible   Boolean  @default(true) // Can toggle home visibility
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_home_locations")
}

